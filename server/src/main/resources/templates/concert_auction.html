<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì½˜ì„œíŠ¸ í‹°ì¼“ ê²½ë§¤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script th:inline="javascript">
        // WebSocket ì—°ê²°
        const socket = new SockJS('/ws');
        const stompClient = Stomp.over(socket);
        const concertId = /*[[${concert.id}]]*/ null;

        stompClient.connect({}, function(frame) {
            stompClient.subscribe('/topic/auction/' + concertId, function(message) {
                const data = JSON.parse(message.body);
                updateAuctionInfo(data);
            });
        });

        function updateAuctionInfo(data) {
            document.getElementById('currentBid').textContent = data.currentBid.toLocaleString();
            document.getElementById('countdown').textContent = formatTimeLeft(data.timeLeft);
            document.getElementById('bidAmount').min = data.currentBid + 1000;
        }

        function formatTimeLeft(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = seconds % 60;
            return `${min}ë¶„ ${sec < 10 ? '0' + sec : sec}ì´ˆ`;
        }

        // í¼ ì œì¶œ ì „ ìœ íš¨ì„± ê²€ì‚¬
        function validateBid(event) {
            const bidAmount = parseInt(document.getElementById('bidAmount').value);
            const currentBid = parseInt(document.getElementById('currentBid').textContent.replace(/,/g, ''));
            
            if (bidAmount <= currentBid) {
                event.preventDefault();
                alert('ì…ì°° ê¸ˆì•¡ì€ í˜„ì¬ ìµœê³ ê°€ë³´ë‹¤ ë†’ì•„ì•¼ í•©ë‹ˆë‹¤.');
            }
        }
    </script>
</head>
<body class="bg-light p-4">
<div class="container">
    <h2 class="mb-3">ğŸ« ì½˜ì„œíŠ¸ í‹°ì¼“ ê²½ë§¤</h2>

    <!-- ì½˜ì„œíŠ¸ ì •ë³´ -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title" th:text="${concert.name}">ì½˜ì„œíŠ¸ëª…</h5>
            <p class="card-text">
                ì¼ì •: <span th:text="${#temporals.format(concert.date, 'yyyy-MM-dd HH:mm')}">2025-06-10</span><br>
                ì¥ì†Œ: <span th:text="${concert.location}">ì„œìš¸ ì˜¬ë¦¼í”½ê³µì›</span>
            </p>
        </div>
    </div>

    <!-- ì…ì°° ì •ë³´ -->
    <div class="card mb-4" th:if="${isActive}">
        <div class="card-body">
            <h5>ğŸ“ˆ í˜„ì¬ ìµœê³  ì…ì°°ê°€: <span class="text-primary fw-bold" id="currentBid" th:text="${#numbers.formatInteger(currentBid, 3, 'COMMA')}">120,000</span>ì›</h5>
            <p>â³ ë‚¨ì€ ì‹œê°„: <span id="countdown">--:--</span></p>

            <!-- ì…ì°° í¼ -->
            <form th:action="@{/auction/bid}" method="post" class="mt-3" onsubmit="validateBid(event)">
                <div class="mb-3">
                    <label for="bidAmount" class="form-label">ì…ì°° ê¸ˆì•¡ (ì›)</label>
                    <input type="number" class="form-control" id="bidAmount" name="bidAmount" 
                           th:min="${currentBid + 1000}" step="1000" required>
                    <small class="text-muted">ìµœì†Œ ì…ì°° ë‹¨ìœ„: 1,000ì›</small>
                </div>
                <input type="hidden" name="concertId" th:value="${concert.id}">
                <button type="submit" class="btn btn-success">ì…ì°°í•˜ê¸°</button>
            </form>
        </div>
    </div>

    <!-- ê²½ë§¤ ì¢…ë£Œ ë©”ì‹œì§€ -->
    <div class="card mb-4" th:unless="${isActive}">
        <div class="card-body">
            <h5 class="text-danger">âš ï¸ ê²½ë§¤ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤</h5>
            <p>ìµœì¢… ë‚™ì°°ê°€: <span class="text-primary fw-bold" th:text="${#numbers.formatInteger(currentBid, 3, 'COMMA')}">120,000</span>ì›</p>
        </div>
    </div>

    <!-- ì…ì°° ì„±ê³µ ë©”ì‹œì§€ -->
    <div th:if="${success}" class="alert alert-success" role="alert">
        ì…ì°°ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!
    </div>

    <!-- ì…ì°° ì‹¤íŒ¨ ë©”ì‹œì§€ -->
    <div th:if="${error}" class="alert alert-danger" role="alert">
        ì…ì°° ê¸ˆì•¡ì€ í˜„ì¬ ìµœê³ ê°€ë³´ë‹¤ ë†’ì•„ì•¼ í•©ë‹ˆë‹¤.
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
